<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wiki-like Editor — GitHub Pages Ready</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#7dd3fc;--glass: rgba(255,255,255,0.03)}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial}
    body{background:linear-gradient(180deg,#071021 0%, #0b1522 100%);color:#e6eef6}

    .layout{display:flex;min-height:100vh}
    /* sidebar */
    .sidebar{width:300px;min-width:240px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-right:1px solid rgba(255,255,255,0.03);padding:20px;display:flex;flex-direction:column;gap:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#60a5fa);display:flex;align-items:center;justify-content:center;font-weight:700;color:#04263b}
    .site-title{font-size:16px;font-weight:600}
    .site-sub{font-size:12px;color:var(--muted)}

    .pages{flex:1;overflow:auto}
    .pages h4{margin:6px 0 8px 0;color:var(--muted);font-size:12px}
    .page-list{display:flex;flex-direction:column;gap:8px}
    .page-item{padding:8px 10px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:space-between}
    .page-item:hover{background:var(--glass)}
    .page-item.active{background:rgba(125,211,252,0.06);box-shadow:0 6px 18px rgba(0,0,0,0.25)}

    .controls{display:flex;gap:8px}
    button{background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit;padding:8px 10px;border-radius:8px;cursor:pointer}
    button.primary{background:linear-gradient(90deg,var(--accent),#60a5fa);border:none;color:#012233}

    /* main */
    main{flex:1;padding:28px;display:flex;flex-direction:column;gap:18px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .breadcrumbs{font-size:13px;color:var(--muted)}

    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.012));border:1px solid rgba(255,255,255,0.03);padding:18px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}

    .title-row{display:flex;align-items:center;gap:12px}
    .page-title{font-size:20px;font-weight:700}
    .meta{color:var(--muted);font-size:13px}

    .sections{display:flex;flex-direction:column;gap:12px}
    .section{border-radius:10px;padding:12px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}
    .section .section-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .section .section-head h3{margin:0;font-size:16px}

    .section .body{margin-top:8px}
    .section .content{min-height:40px;padding:6px;border-radius:8px;background:rgba(0,0,0,0.03);outline:none}

    .small{font-size:13px;color:var(--muted)}
    .img-preview{max-width:100%;border-radius:8px;margin-top:8px}

    /* add modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.6));z-index:60}
    .modal .modal-card{width:720px;max-width:92%;background:#071226;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .form-row{display:flex;gap:8px;align-items:center}
    .form-row label{min-width:110px;color:var(--muted)}
    input[type=text],textarea,select{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    textarea{min-height:120px}

    .footer-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    /* responsiveness */
    @media (max-width:900px){.sidebar{display:none}.layout{flex-direction:column}.topbar{flex-wrap:wrap}}
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar card">
      <div class="brand">
        <div class="logo">W</div>
        <div>
          <div class="site-title">Mini Wiki</div>
          <div class="site-sub">Editable content · GitHub Pages</div>
        </div>
      </div>

      <div class="controls">
        <button id="newPageBtn">+ New Page</button>
        <button id="importBtn">Import</button>
        <button id="exportBtn" class="primary">Export</button>
      </div>

      <div class="pages card">
        <h4>Pages</h4>
        <div class="page-list" id="pageList"></div>
      </div>

      <div class="small">Tip: content is saved locally (localStorage). Use Export to create a backup or share as JSON.</div>
    </aside>

    <main>
      <div class="topbar">
        <div class="breadcrumbs" id="breadcrumbs">/</div>
        <div>
          <button id="toggleEditBtn">Enter Edit Mode</button>
        </div>
      </div>

      <div class="card">
        <div class="title-row">
          <div>
            <div class="page-title" id="pageTitle">Welcome</div>
            <div class="meta" id="pageMeta">Last saved: —</div>
          </div>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <button id="addSectionBtn">+ Section</button>
            <button id="saveBtn" class="primary" style="display:none">Save</button>
          </div>
        </div>

        <div class="sections" id="sectionsContainer">
          <!-- sections will be rendered here -->
        </div>
      </div>
    </main>
  </div>

  <!-- modal for new page / section -->
  <div class="modal" id="modal">
    <div class="modal-card">
      <h3 id="modalTitle">Add</h3>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:12px">
        <div class="form-row"><label>Title</label><input id="mTitle" type="text" placeholder="Section or Page title"></div>
        <div class="form-row"><label>Collapsible</label><select id="mColl"><option value="false">No</option><option value="true">Yes</option></select></div>
        <div class="form-row"><label>Content</label><textarea id="mContent" placeholder="Write markdown-like content (basic HTML allowed)"></textarea></div>
        <div class="form-row"><label>Image</label><input id="mImage" type="file" accept="image/*"></div>
      </div>
      <div class="footer-actions">
        <button id="modalCancel">Cancel</button>
        <button id="modalSave" class="primary">Add</button>
      </div>
    </div>
  </div>

  <input id="fileImport" type="file" accept="application/json" style="display:none">

  <script>
    /* Simple Wiki-like editable site. Uses localStorage for persistence and stores images as base64 data URLs.
       Ready to be committed to a GitHub Pages repository as index.html.
    */

    const STORAGE_KEY = 'mini-wiki-v1';

    // default content
    const defaultState = {
      pages:[{
        id: genId(),
        title:'Welcome',
        updated: Date.now(),
        sections:[
          {id: genId(),title:'Introduction',collapsible:false,content:'This is a small wiki-like editor. Click \"Enter Edit Mode\" to change content.',image:null,open:true},
          {id: genId(),title:'Features',collapsible:true,content:'- Create pages\n- Add multiple sections\n- Upload images (saved locally)\n- Collapsible sections',image:null,open:false}
        ]
      }]
    };

    let state = loadState();
    let currentPageId = state.pages[0].id;
    let editing = false;

    // DOM refs
    const pageList = document.getElementById('pageList');
    const pageTitle = document.getElementById('pageTitle');
    const pageMeta = document.getElementById('pageMeta');
    const sectionsContainer = document.getElementById('sectionsContainer');
    const toggleEditBtn = document.getElementById('toggleEditBtn');
    const addSectionBtn = document.getElementById('addSectionBtn');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const mTitle = document.getElementById('mTitle');
    const mColl = document.getElementById('mColl');
    const mContent = document.getElementById('mContent');
    const mImage = document.getElementById('mImage');
    const modalSave = document.getElementById('modalSave');
    const modalCancel = document.getElementById('modalCancel');
    const saveBtn = document.getElementById('saveBtn');
    const newPageBtn = document.getElementById('newPageBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const fileImport = document.getElementById('fileImport');

    // initial render
    renderPageList();
    renderCurrentPage();

    // event listeners
    toggleEditBtn.addEventListener('click',()=>{
      editing = !editing; setEditMode(editing);
    });
    addSectionBtn.addEventListener('click',()=> openModal('section'));
    modalCancel.addEventListener('click', closeModal);
    modalSave.addEventListener('click', onModalSave);
    saveBtn.addEventListener('click', saveStateAndExitEdit);
    newPageBtn.addEventListener('click', ()=> openModal('page'));
    exportBtn.addEventListener('click', exportJSON);
    importBtn.addEventListener('click', ()=> fileImport.click());
    fileImport.addEventListener('change', handleFileImport);

    function genId(){return 'id-'+Math.random().toString(36).slice(2,9)}

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) { localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultState)); return defaultState }
        return JSON.parse(raw);
      }catch(e){console.error(e); localStorage.removeItem(STORAGE_KEY); localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultState)); return defaultState}
    }

    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    function renderPageList(){
      pageList.innerHTML='';
      state.pages.forEach(p=>{
        const el = document.createElement('div'); el.className='page-item'+(p.id===currentPageId? ' active':'');
        el.onclick = ()=>{ currentPageId=p.id; renderCurrentPage(); renderPageList(); }
        el.innerHTML = `<div style="display:flex;flex-direction:column"><strong>${escapeHtml(p.title)}</strong><span class='small'>${new Date(p.updated).toLocaleString()}</span></div><div class='small'>${p.sections.length} sec</div>`;
        pageList.appendChild(el);
      })
    }

    function renderCurrentPage(){
      const page = getCurrentPage(); if(!page) return;
      pageTitle.textContent = page.title;
      pageMeta.textContent = 'Last saved: '+ new Date(page.updated).toLocaleString();
      renderSections(page.sections);
      document.getElementById('breadcrumbs').textContent = '/' + page.title;
    }

    function renderSections(sections){
      sectionsContainer.innerHTML='';
      sections.forEach(sec=>{
        const s = document.createElement('div'); s.className='section card'; s.dataset.id=sec.id;
        const head = document.createElement('div'); head.className='section-head';
        const h3 = document.createElement('h3'); h3.textContent = sec.title;
        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';

        const toggleBtn = document.createElement('button'); toggleBtn.textContent = sec.collapsible ? (sec.open? 'Collapse':'Expand') : '—'; toggleBtn.disabled = !sec.collapsible;
        toggleBtn.onclick = ()=>{ sec.open = !sec.open; saveState(); renderCurrentPage(); }

        const editBtn = document.createElement('button'); editBtn.textContent='Edit';
        editBtn.onclick = ()=> openModal('section',sec);

        const delBtn = document.createElement('button'); delBtn.textContent='Delete';
        delBtn.onclick = ()=>{ if(confirm('Delete this section?')){ const page=getCurrentPage(); page.sections = page.sections.filter(x=>x.id!==sec.id); saveState(); renderPageList(); renderCurrentPage(); }}

        actions.appendChild(toggleBtn); actions.appendChild(editBtn); actions.appendChild(delBtn);
        head.appendChild(h3); head.appendChild(actions);

        const body = document.createElement('div'); body.className='body';
        if(!sec.collapsible || sec.open){
          const content = document.createElement('div'); content.className='content'; content.contentEditable = editing; content.innerHTML = sanitizeHtml(sec.content);
          // live edit -> update model
          content.addEventListener('input', e=>{
            sec.content = e.target.innerHTML; markUnsaved();
          })
          body.appendChild(content);

          if(sec.image){
            const img = document.createElement('img'); img.src = sec.image; img.className='img-preview'; body.appendChild(img);
          }
        }

        s.appendChild(head); s.appendChild(body);
        sectionsContainer.appendChild(s);
      })
    }

    function getCurrentPage(){ return state.pages.find(p=>p.id===currentPageId) }

    function setEditMode(enabled){
      editing = enabled; toggleEditBtn.textContent = editing ? 'Exit Edit Mode' : 'Enter Edit Mode';
      saveBtn.style.display = editing ? 'inline-block' : 'none';
      // make contenteditable for visible content blocks
      document.querySelectorAll('.content').forEach(c=> c.contentEditable = editing);
      // when toggling off, re-render to ensure events wired
      if(!editing) renderCurrentPage();
    }

    // modal: type page | section
    let modalContext = null;
    function openModal(type, data=null){
      modalContext = {type, data};
      modalTitle.textContent = type==='page' ? 'New Page' : 'Add / Edit Section';
      mTitle.value = data ? data.title : '';
      mColl.value = data ? String(!!data.collapsible) : 'false';
      mContent.value = data ? data.content : '';
      mImage.value = '';
      modal.style.display='flex';
      mTitle.focus();
    }
    function closeModal(){ modal.style.display='none'; }

    async function onModalSave(){
      const title = mTitle.value.trim() || 'Untitled';
      const collapsible = mColl.value === 'true';
      const content = mContent.value;
      let imageData = null;

      if(mImage.files && mImage.files[0]){
        imageData = await readFileAsDataURL(mImage.files[0]);
      }

      if(modalContext.type==='page'){
        const p = {id:genId(),title,updated:Date.now(),sections:[]};
        if(imageData) p.cover = imageData;
        state.pages.push(p);
        currentPageId = p.id;
      }else{
        if(modalContext.data){
          // edit existing
          const s = modalContext.data;
          s.title = title; s.collapsible = collapsible; s.content = content; if(imageData) s.image=imageData;
        }else{
          // add new
          const page = getCurrentPage();
          page.sections.push({id:genId(),title,collapsible,content,image:imageData,open:!collapsible});
        }
        getCurrentPage().updated = Date.now();
      }

      saveState(); renderPageList(); renderCurrentPage(); closeModal();
    }

    function readFileAsDataURL(file){
      return new Promise((res,rej)=>{
        const r=new FileReader(); r.onload = ()=> res(r.result); r.onerror = rej; r.readAsDataURL(file);
      })
    }

    function saveStateAndExitEdit(){
      const page = getCurrentPage(); page.updated = Date.now(); saveState(); setEditMode(false); renderPageList(); renderCurrentPage(); alert('Saved locally. Use Export to download JSON backup.')
    }

    function exportJSON(){
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='mini-wiki-export.json'; a.click(); URL.revokeObjectURL(url);
    }

    function handleFileImport(e){
      const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>{
        try{ const imported = JSON.parse(r.result); if(imported.pages && Array.isArray(imported.pages)){ state = imported; saveState(); currentPageId = state.pages[0]?.id || genId(); renderPageList(); renderCurrentPage(); alert('Imported.'); }else alert('Invalid file format.'); }catch(err){alert('Failed to import: '+err.message)}
      }; r.readAsText(f);
    }

    function markUnsaved(){ pageMeta.textContent = 'Unsaved changes — remember to Save'; }

    // small helpers
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }

    function sanitizeHtml(raw){
      // Very small sanitizer: allow basic tags for formatting. We keep this intentionally minimal.
      // Remove script tags and on* attributes.
      const tmp = document.createElement('div'); tmp.innerText = raw; // first escape any raw HTML
      let html = tmp.innerHTML;
      // Allow simple line-breaks and lists by converting newlines to <br>
      html = html.replace(/\n/g,'<br>');
      return html;
    }

    // small accessibility: keyboard shortcuts
    document.addEventListener('keydown', e=>{
      if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='s'){ e.preventDefault(); saveStateAndExitEdit(); }
      if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='e'){ e.preventDefault(); setEditMode(!editing); }
    })

    // expose simple API for advanced users (window for devtools)
    window.__miniWiki = {state,saveState,loadState,exportJSON}
  </script>
</body>
</html>
